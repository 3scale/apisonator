#!/usr/bin/env bash

function start_mongodb {
  mongod --logpath /tmp/mongod01_backend.log --dbpath /tmp --logappend --fork
}

function stop_mongodb {
  mongod --dbpath /tmp --shutdown
}

if [ -n "$RVM_RUBY" ]
then
  export CODECLIMATE_REPO_TOKEN=codeclimate_token
  export REPORT_CODECLIMATE=1
  export TO_FILE=1

  export RACK_ENV=test
  start_mongodb
  sleep 10
  rvm $RVM_RUBY do bash -c 'bundle install --deployment --without development && bundle exec rake test --trace'
  export RET=$?;
  stop_mongodb
  (($RET == 0))
else
  echo "Missing $RVM_RUBY env variable"
  exit 1
fi
