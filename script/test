#!/bin/bash

SCRIPT_DIR=$(dirname "$(readlink -f $0)")
. ${SCRIPT_DIR}/lib/functions

function cleanup()
{
    if [ -z "$CI" ]; then
        stop_services
    fi
}

function do_license_check()
{
    if [ -n "$CI" ]; then
        bundle_exec rake license_finder
    fi
}

function do_test()
{
    bundle_exec rake "$@"
}

trap 'cleanup' INT

start_services

if test "x${TEST_RUBY_VERSION}" != "x"; then
    if test -r ${SCRIPT_DIR}/lib/rbenv/ruby_versions; then
        . ${SCRIPT_DIR}/lib/rbenv/ruby_versions
        set_ruby_version "${TEST_RUBY_VERSION}"
    elif test -r ~/.local/bin/ruby_versions; then
        . ~/.local/bin/ruby_versions
        set_ruby_version "${TEST_RUBY_VERSION}"
    else
        echo "Cannot find rbenv support scripts, falling back to default version" >&2
    fi
fi

export RACK_ENV=test

do_license_check && do_test
EXITVAL=$?

cleanup

exit ${EXITVAL}
