From 75cc76c43c985cadb6147e297793f5ad3666784c Mon Sep 17 00:00:00 2001
From: Alejandro Martinez Ruiz <alex@flawedcode.org>
Date: Mon, 6 Jul 2015 19:49:36 +0200
Subject: [PATCH 04/16] test/error_storage: convert YAJL to JSON

---
 test/unit/error_storage_test.rb | 34 +++++++++++++++++++--------------
 1 file changed, 20 insertions(+), 14 deletions(-)

diff --git a/test/unit/error_storage_test.rb b/test/unit/error_storage_test.rb
index e144ee85c..89d370c92 100644
--- a/test/unit/error_storage_test.rb
+++ b/test/unit/error_storage_test.rb
@@ -19,7 +19,7 @@ class ErrorStorageTest < Test::Unit::TestCase
 
     assert_not_nil raw_error
 
-    error = Yajl::Parser.parse(raw_error)
+    error = JSON.parse(raw_error)
 
     assert_equal 'application_not_found',                   error['code']
     assert_equal 'application with id="boo" was not found', error['message']
@@ -27,15 +27,19 @@ class ErrorStorageTest < Test::Unit::TestCase
   end
 
   test '#list returns errors from the storage' do
-    @storage.rpush("errors/service_id:#{@service_id}", 
-                   Yajl::Encoder.encode(:code      => 'application_not_found',
-                                        :message   => 'application with id="foo" was not found',
-                                        :timestamp => '2010-07-29 15:23:00 UTC'))
-
-    @storage.rpush("errors/service_id:#{@service_id}", 
-                   Yajl::Encoder.encode(:code      => 'metric_invalid',
-                                        :message   => 'metric "bars" is invalid',
-                                        :timestamp => '2010-07-29 15:44:00 UTC'))
+    @storage.rpush("errors/service_id:#{@service_id}",
+                   {
+                     code:      'application_not_found',
+                     message:   'application with id="foo" was not found',
+                     timestamp: '2010-07-29 15:23:00 UTC'
+                   }.to_json)
+
+    @storage.rpush("errors/service_id:#{@service_id}",
+                   {
+                     code:      'metric_invalid',
+                     message:   'metric "bars" is invalid',
+                     timestamp: '2010-07-29 15:44:00 UTC'
+                   }.to_json)
 
     expected = [{:code      => 'application_not_found',
                  :message   => 'application with id="foo" was not found',
@@ -121,10 +125,12 @@ class ErrorStorageTest < Test::Unit::TestCase
   end
 
   test '#delete_all deletes all errors from the storage' do
-    @storage.rpush("errors/service_id:#{@service_id}", 
-                   Yajl::Encoder.encode(:code      => 'application_not_found',
-                                        :message   => 'application with id="foo" was not found',
-                                        :timestamp => '2010-09-03 17:15:00 UTC'))
+    @storage.rpush("errors/service_id:#{@service_id}",
+                   {
+                     code:      'application_not_found',
+                     message:   'application with id="foo" was not found',
+                     timestamp: '2010-09-03 17:15:00 UTC'
+                   }.to_json)
 
     ErrorStorage.delete_all(@service_id)
 
-- 
2.21.0

