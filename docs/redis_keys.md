# Redis keys

## Introduction

This document lists the key-value entries stored in the _backend_ redis, specifically the "storage" database, which is configured with the `CONFIG_REDIS_PROXY` environment variable and others starting with `CONFIG_REDIS_`.
Backend also uses another database, which can be another logical database within the same redis instance or another instance (recommended for production use), and configured by environment variables starting with `CONFIG_QUEUES_`. This "queues" database is used only for [resque](https://github.com/resque/resque), the background jobs library, and contains keys like `resque:queues` and `resque:workers`. This document doesn't cover this database and only describes the "storage" database.

All keys can be split in two categories:
1. Coming from the _system_ (porta) component
2. Generated within _backend_ component

The keys in the first category are the details of the services, applications, application keys, service tokens etc. The source of truth for such data is the _system_ component database. Whenever a service, an application, an application key etc. are created in _system_ via the UI or API, the information about these objects is pushed to _backend_ through the Internal API (see the specification at [docs/specs/backend_internal.yaml](docs%2Fspecs%2Fbackend_internal.yaml)). [pisoni](https://github.com/3scale/pisoni) is a Ruby client that porta uses for consuming this API.

In case this kind of data gets out of sync or gets deleted from _backend_ redis, it can always be restored from _system_. The best way to restore it is to run a Rake task from _porta_ project:

```
bundle exec rake backend:storage:rewrite
bundle exec rake backend:storage:enqueue_rewrite
```

The difference between the two is that the latter performs the operation through background jobs, which is preferred for large data sets.

The keys in the second category are the ones generated by _backend_ itself. These are mainly the keys holding the usage counters for each application - how many calls were made by a certain application on a certain metric. For this information _backend_ redis is the source of truth, and this data doesn't get pulled into the _system_ database (_system_ fetches this data directly from the _backend_ Redis). Once this information is deleted, it cannot be restored.

## From System

### Services

| Pattern                                                   | Parameters                | Type   | Example key                                                                                         | Example values                       | Description                                                                                                   |
|-----------------------------------------------------------|---------------------------|--------|-----------------------------------------------------------------------------------------------------|--------------------------------------|---------------------------------------------------------------------------------------------------------------|
| `provider_keys_set`                                       | -                         | set    | `provider_keys_set`                                                                                 | `1) "a640cb1efe587e0b0e811d5200d77f3b" 2) "20d545e27d990a0dc3da61f7bc14f0b7"` | List of provider keys |
| `service/id:SERVICE_ID/backend_version`                   | SERVICE_ID                | string | `service/id:2/backend_version`                                                                      | `"1"`, or `"2"`, or `"oauth"`        | Service authentication type: "1" for User Key, "2" for App Id / App Key, "oauth" for OpenID Connect           |
| `service/id:SERVICE_ID/referrer_filters_required`         | SERVICE_ID                | string | `service/id:2/referrer_filters_required`                                                            | `"0"` or `"1"`                       | Whether referrer filters are required for the service: "1" if required, "0" otherwise                         |
| `service/id:SERVICE_ID/state`                             | SERVICE_ID                | string | `service/id:2/state`                                                                                | `"active"`                           | Looks like something that is being maintained for backwards compatibility                                     |
| `service/id:SERVICE_ID/provider_key`                      | SERVICE_ID                | string | `service/id:2/provider_key`                                                                         | `"a640cb1efe587e0b0e811d5200d77f3b"` | Provider key associated to the service                                                                        |
| `service/provider_key:PROVIDER_KEY/ids`                   | PROVIDER_KEY              | set    | `service/provider_key:a640cb1efe587e0b0e811d5200d77f3b/ids`                                         | `1) "2" 2) "3" 3) "4"`               | Service IDs linked to the provider key                                                                        |
| `service/provider_key:PROVIDER_KEY/id`                    | PROVIDER_KEY              | set    | `service/provider_key:a640cb1efe587e0b0e811d5200d77f3b/id`                                          | `"2"`                                | Default service ID linked to the provider key (I think this is deprecated)                                    |
| `service_id:SERVICE_ID/applications`                      | SERVICE_ID                | set    | `service_id:2/applications`                                                                         | `1) "593a8c1a"`                      | List of app IDs of the applications that belong to the service                                                |
| `service_token/token:SERVICE_TOKEN/service_id:SERVICE_ID` | SERVICE_TOKEN, SERVICE_ID | hash   | `service_token/token:e63b02be1205675534d80b3ebad532d6300919a5f80f340486f3846a19cfee82/service_id:2` | `1) "permissions" 2) ""`             | Combination of service token and service ID. The value seems to be always `permissions: ''`, and is not used. |
| `services_set`                                            | -                         | set    | `services_set`                                                                                      | `1) "1" 2) "2"`                      | List of service IDs                                                                                           |

### Applications

| Pattern                                                        | Parameters           | Type   | Example key                                                        | Example values                               | Description                                                                                      |
|----------------------------------------------------------------|----------------------|--------|--------------------------------------------------------------------|----------------------------------------------|--------------------------------------------------------------------------------------------------|
| `application/service_id:SERVICE_ID/id:APP_ID/plan_id`          | SERVICE_ID, APP_ID   | string | `application/service_id:2/id:593a8c1a/plan_id`                     | `"44"`                                       | Getting the plan ID for the application by its app ID and service ID                             |
| `application/service_id:SERVICE_ID/id:APP_ID/plan_name`        | SERVICE_ID, APP_ID   | string | `application/service_id:2/id:593a8c1a/plan_name`                   | `"Test plan"`                                | Getting the plan name of the application by its app ID and service ID                            |
| `application/service_id:SERVICE_ID/id:APP_ID/state`            | SERVICE_ID, APP_ID   | string | `application/service_id:2/id:593a8c1a/state`                       | `"active"`, or `"pending"`, or `"suspended"` | Getting the state of the application by its app ID and service ID                                |
| `application/service_id:SERVICE_ID/id:APP_ID/keys`             | SERVICE_ID, APP_ID   | set    | `application/service_id:2/id:593a8c1a/keys`                        | `1) "91efe8a356c83e94b40e54cce211a1a4"`      | List of application keys associated to the application (for App Id / App Key mode)               |
| `application/service_id:SERVICE_ID/id:APP_ID/redirect_url`     | SERVICE_ID, APP_ID   | string | `application/service_id:2/id:593a8c1a/redirect_url`                | `"https://example.com/redirect"`             | Redirect URL of the aplication (for application of services with OAuth/OpenID Connect auth mode) |
| `application/service_id:SERVICE_ID/id:APP_ID/referrer_filters` | SERVICE_ID, APP_ID   | set    | `application/service_id:2/id:593a8c1a/referrer_filters`            | `1) "*.example.org" 2) "test.org"`           | List of referrer filters associated to the application                                           |
| `application/service_id:SERVICE_ID/key:USER_KEY/id`            | SERVICE_ID, USER_KEY | string | `application/service_id:2/key:842b61b250666fa4c0d916c5b8c0e7ac/id` | `"593a8c1a"`                                 | Getting app ID of the application by its user key and service ID                                 |

### Metrics

| Pattern                                               | Parameters              | Type   | Example key                           | Example values | Description                                                     |
|-------------------------------------------------------|-------------------------|--------|---------------------------------------|----------------|-----------------------------------------------------------------|
| `metric/service_id:SERVICE_ID/name:METRIC_NAME/id`    | SERVICE_ID, METRIC_NAME | string | `metric/service_id:2/name:hits/id`    | `"31"`         | Get the ID of the metric by its name and service ID             |
| `metric/service_id:SERVICE_ID/id:METRIC_ID/name`      | SERVICE_ID, METRIC_ID   | string | `metric/service_id:2/id:31/name`      | `"hits"`       | Get the name of the metric by its ID and service ID             |
| `metric/service_id:SERVICE_ID/id:METRIC_ID/parent_id` | SERVICE_ID, METRIC_ID   | string | `metric/service_id:2/id:42/parent_id` | `"31"`         | Get the ID of the parent of the metric by its ID and service ID |

### Usage limits

| Pattern                                                                        | Parameters                             | Type   | Example key                                               | Example values | Description                                                                                                                       |
|--------------------------------------------------------------------------------|----------------------------------------|--------|-----------------------------------------------------------|----------------|-----------------------------------------------------------------------------------------------------------------------------------|
| `usage_limit/service_id:SERVICE_ID/plan_id:PLAN_ID/metric_id:METRIC_ID/PERIOD` | SERVICE_ID, PLAN_ID, METRIC_ID, PERIOD | string | `usage_limit/service_id:2/plan_id:44/metric_id:31/minute` | `"100"`        | Usage limit for a specific plan and metric in a period, that can be: `minute`, `hour`, `day`, `week`, `month`, `year`, `eternity` |

## Generated by backend

### Stats

Stats keys hold the counters for application usage, reported through the Service Management API, specifically, `/transactions/authrep.xml`, `transactions/oauth_authrep.xml`, and `/transactions.xml` endpoints. For example, sending `usage[hits]=1` in authrep calls or `transactions[0][usage][hits]=1` in transaction calls will increase the counter for the metric "hits" by `1`. There are different consumers of this API:
1) APIcast gateway is the most common and the recommended one. It reports the usage of the providers' APIs managed by 3scale by developers' applications.
2) Some API providers that don't use APIcast gateway may send the usage to the Service Management API directly from their API code.
3) For testing purposes, Service Management API can be consumed from Active Docs via Swagger UI, from the admin portal's "3scale API Docs" section (`/p/admin/api_docs`).
4) There is Master Service which belongs to the Master account that also has metrics defined that the usage can be reported to, specifically, the metrics `account`, `billing` and `analytics`, which capture the usage of the corresponding _system_ APIs: Account Management API, Billing API, Analytics API accordingly. Their usage is reported by `ReportTrafficWorker` in _system_, given that the feature is enabled (i.e. `report_traffic` options is set to `true` in `settings.yml`).

| Pattern                                                                                           | Parameters                                                  | Type   | Example key                                                             | Example values  | Description                                                |
|---------------------------------------------------------------------------------------------------|-------------------------------------------------------------|--------|-------------------------------------------------------------------------|-----------------|------------------------------------------------------------|
| `stats/{service:SERVICE_ID}/cinstances`                                                           | SERVICE_ID                                                  | set    | `stats/{service:2}/cinstances`                                          | `1) "593a8c1a"` | List of app IDs of applications that have received traffic |
| `stats/{service:SERVICE_ID}/metric:METRIC_ID/eternity`                                            | SERVICE_ID, METRIC_ID                                       | string | `stats/{service:2}/metric:6/eternity`                                   | `"100"`         | Usage counter for a metric per eternity                    |
| `stats/{service:SERVICE_ID}/metric:METRIC_ID/PERIOD:PERIOD_TIMESTAMP`                             | SERVICE_ID, METRIC_ID, PERIOD, PERIOD_TIMESTAMP             | string | `stats/{service:2}/metric:6/hour:2025042317`                            | `"10"`          | Usage counter for a metric per period                      |
| `stats/{service:SERVICE_ID}/response_code:RESPONSE_CODE/eternity`                                 | SERVICE_ID, RESPONSE_CODE                                   | string | `stats/{service:2}/response_code:200/eternity`                          | `"100"`         | Response codes counter for a metric per eternity           |
| `stats/{service:SERVICE_ID}/response_code:RESPONSE_CODE/PERIOD:PERIOD_TIMESTAMP`                  | SERVICE_ID, RESPONSE_CODE, PERIOD, PERIOD_TIMESTAMP         | string | `stats/{service:2}/response_code:200/day:20250423`                      | `"10"`          | Response codes counter for a metric per period             |
| `stats/{service:SERVICE_ID}/cinstance:APP_ID/metric:METRIC_ID/eternity`                           | SERVICE_ID, APP_ID, METRIC_ID                               | string | `stats/{service:2}/cinstance:593a8c1a/metric:6/eternity`                | `"100"`         | Usage counter for an application and a metric per eternity |
| `stats/{service:SERVICE_ID}/cinstance:APP_ID/metric:METRIC_ID/PERIOD:PERIOD_TIMESTAMP`            | SERVICE_ID, APP_ID, METRIC_ID, PERIOD, PERIOD_TIMESTAMP     | string | `stats/{service:2}/cinstance:593a8c1a/metric:6/day:20250423`            | `"100"`         | Usage counter for an application and a metric per period   |
| `stats/{service:SERVICE_ID}/cinstance:APP_ID/response_code:RESPONSE_CODE/eternity`                | SERVICE_ID, APP_ID, RESPONSE_CODE                           | string | `stats/{service:2}/cinstance:593a8c1a/response_code:200/eternity`       | `"100"`         | Response codes counter per eternity                        |
| `stats/{service:SERVICE_ID}/cinstance:APP_ID/response_code:RESPONSE_CODE/PERIOD:PERIOD_TIMESTAMP` | SERVICE_ID, APP_ID, RESPONSE_CODE, PERIOD, PERIOD_TIMESTAMP | string | `stats/{service:2}/cinstance:593a8c1a/response_code:200/month:20250401` | `"100"`         | Response codes counter per period                          |

The API usage is accumulated per different period granularity at the same time.
`PERIOD` can be one of the following: `minute`, `hour`, `day`, `week`, `month`, `year`. `eternity` is also one of periods, but in the table it is referenced separately, because it doesn't have the period timestamp.
The format of the `PERIOD_TIMESTAMP` depends on the period:
- for `minute`, it's `YYYYMMDDhhmm`, e.g. `202504231742`
- for `hour`, it's `YYYYMMDDhh`, e.g. `2025042317`
- for `day`, it's `YYYYMMDD`, e.g. `20250423`
- for `month`, it's `YYYYMM01`, e.g. `20250401`
- for `year`, it's `YYYY0101`, e.g. `20250101`

Note that the keys at `minute` granularity have a TTL of 180 seconds, once they expire, they get deleted. This is because we don't show per-minute usage in the Analytics, the lowest granularity for visualization is per-hour.

The response codes entries accumulate requests counters for each response code. The values of the `RESPONSE_CODE` can be a subset of HTTP status codes: `200`, `404`, `403`, `500`, `503`, or accumulated by type: `2xx`, `4xx` or `5xx`.
Note that the response codes are only stored, if `log[code]=CODE` parameter is added to the `authrep.xml` or `report.xml` request. APIcast needs to be configured explicitly to include this parameter.

When a request is made, the hit is reported at each granularity level. For example, here is the list of the keys that would be added for a single successful request with `log[code]=200`:
```
stats/{service:2}/cinstance:37ba04ec/metric:6/day:20250423
stats/{service:2}/cinstance:37ba04ec/metric:6/eternity
stats/{service:2}/cinstance:37ba04ec/metric:6/hour:2025042317
stats/{service:2}/cinstance:37ba04ec/metric:6/minute:202504231742 (TTL 180)
stats/{service:2}/cinstance:37ba04ec/metric:6/month:20250401
stats/{service:2}/cinstance:37ba04ec/metric:6/week:20250421
stats/{service:2}/cinstance:37ba04ec/metric:6/year:20250101
stats/{service:2}/cinstance:37ba04ec/response_code:200/day:20250423
stats/{service:2}/cinstance:37ba04ec/response_code:200/eternity
stats/{service:2}/cinstance:37ba04ec/response_code:200/hour:2025042317
stats/{service:2}/cinstance:37ba04ec/response_code:200/minute:202504231742 (TTL 180)
stats/{service:2}/cinstance:37ba04ec/response_code:200/month:20250401
stats/{service:2}/cinstance:37ba04ec/response_code:200/week:20250421
stats/{service:2}/cinstance:37ba04ec/response_code:200/year:20250101
stats/{service:2}/cinstance:37ba04ec/response_code:2XX/day:20250423
stats/{service:2}/cinstance:37ba04ec/response_code:2XX/eternity
stats/{service:2}/cinstance:37ba04ec/response_code:2XX/hour:2025042317
stats/{service:2}/cinstance:37ba04ec/response_code:2XX/minute:202504231742 (TTL 180)
stats/{service:2}/cinstance:37ba04ec/response_code:2XX/month:20250401
stats/{service:2}/cinstance:37ba04ec/response_code:2XX/week:20250421
stats/{service:2}/cinstance:37ba04ec/response_code:2XX/year:20250101
stats/{service:2}/cinstances
stats/{service:2}/metric:6/day:20250423
stats/{service:2}/metric:6/eternity
stats/{service:2}/metric:6/hour:2025042317
stats/{service:2}/metric:6/month:20250401
stats/{service:2}/metric:6/week:20250421
stats/{service:2}/response_code:200/day:20250423
stats/{service:2}/response_code:200/eternity
stats/{service:2}/response_code:200/hour:2025042317
stats/{service:2}/response_code:200/month:20250401
stats/{service:2}/response_code:200/week:20250421
stats/{service:2}/response_code:2XX/day:20250423
stats/{service:2}/response_code:2XX/eternity
stats/{service:2}/response_code:2XX/hour:2025042317
stats/{service:2}/response_code:2XX/month:20250401
stats/{service:2}/response_code:2XX/week:20250421
```

### Daily traffic

| Pattern                                                           | Parameters                        | Type   | Example key                                            | Example values | Description                                                         |
|-------------------------------------------------------------------|-----------------------------------|--------|--------------------------------------------------------|----------------|---------------------------------------------------------------------|
| `daily_traffic/service:SERVICE_ID/cinstance:APP_ID/DAY_TIMESTAMP` | SERVICE_ID, APP_ID, DAY_TIMESTAMP | string | `daily_traffic/service:17/cinstance:593a8c1a/20250422` | `"100"`        | Auto-incrementing value recording the day when the traffic was sent |

`DAY_TIMESTAMP` has the following format: `YYYYMMDD`.
The key has a TTL of 172800 seconds, or 2 days.

### Events

| Key            | Type       | Example values | Description                                                                                                                    |
|----------------|------------|----------------|--------------------------------------------------------------------------------------------------------------------------------|
| `events/id`    | string     | `"12"`         | Auto-incrementing value recording the ID of events                                                                             |
| `events/queue` | sorted set | -see below-    | A sorted list of events that will be reported to _system_                                                                      |
| `events/ping`  | string     | `"1"`          | A key that is set to 1 will TTL of 60 seconds that indicates whether or not _system_ needs to be notified about the new events |

An example list of events in `events/queue`:

```
{"id":1,"type":"first_traffic","timestamp":"2025-04-23 17:42:39 UTC","object":{"service_id":"2","application_id":"37ba04ec","timestamp":"2025-04-23 17:42:39 UTC"}}
{"id":2,"type":"first_daily_traffic","timestamp":"2025-04-23 17:42:39 UTC","object":{"service_id":"2","application_id":"37ba04ec","timestamp":"2025-04-23 17:42:39 UTC"}}
{"id":3,"type":"alert","timestamp":"2025-04-23 19:03:43 UTC","object":{"id":1,"utilization":80,"max_utilization":0.8,"application_id":"37ba04ec","service_id":"2","timestamp":"2025-04-23 19:03:43 UTC",
```

When the first event is created, `events/id` key is created, and information about the event is pushed to `events/queue` - the `"id"` field of the last element in `events/queue` is the number stored in `events/id`.

When events are added, `events/ping` key is set to `"1"` with TTL of 60 seconds. Once the key is set, the events are not notified. If on one of the subsequent events `events/ping` is missing, _system_ is notified about new events via API.

_system_ then requests the events, and once _backend_ returns them, they get deleted from `events/queue`. If all events are deleted from the sorted set, the key is deleted too (this is the default redis behavior).

## Alerts

Alert-related keys are in their own category, because there are keys with data that is coming from _system_, and there are also keys generated from within _backend_.

| Pattern                                                                   | Parameters                      | Type   | Example key                       | Example values           | Description                                                                                           |
|---------------------------------------------------------------------------|---------------------------------|--------|-----------------------------------|--------------------------|-------------------------------------------------------------------------------------------------------|
| `alerts/current_id`                                                       | -                               | string | `alerts/current_id`               | `"12"`                   | Auto-incrementing value recording the ID of alerts.                                                   |
| `alerts/service_id:SERVICE_ID/allowed_set`                                | SERVICE_ID                      | set    | `alerts/service_id:2/allowed_set` | `1) "0" 2) "50" 3) "100"` | List of usage levels that should trigger alerts for the service                                       |
| `alerts/service_id:SERVICE_ID/app_id:APP_ID/ALERT_LEVEL/already_notified` | SERVICE_ID, APP_ID, ALERT_LEVEL | string | `alerts/service_id:17/app_id:593a8c1a/50/already_notified` | `"1"`                     | A key indicating whether an alert has already been created for the application at the specified level |

`ALERT_LEVEL` is one of the following: `50`, `80`, `90`, `100`, `120`, `150`, `200`, `300`.
The TTL for the `already_notified` keys is 24*3600 seconds - 1 day.

The ID that is stored in `alerts/current_id` is the ID within the "object" field in the events of type "alert" stored in `events/queue`.

## Notify keys

There is a key `notify/aggregator/batch` of type "list" that is used for notifying the usage to the multitenant's Master. An example value of the key:

```
{"provider_key":"0849d4c669c041764addb65cd665a49b","usage":{"transactions/authorize":1,"transactions":1},"time":"2023-01-11 13:04:00 UTC"}
{"provider_key":"0849d4c669c041764addb65cd665a49b","usage":{"transactions/authorize":1,"transactions":1},"time":"2023-01-11 13:04:00 UTC"}
{"provider_key":"0849d4c669c041764addb65cd665a49b","usage":{"transactions/authorize":1,"transactions":1},"time":"2023-01-11 13:27:00 UTC"}
{"provider_key":"0849d4c669c041764addb65cd665a49b","usage":{"transactions/authorize":1,"transactions":1},"time":"2023-01-11 13:28:00 UTC"}
{"provider_key":"0849d4c669c041764addb65cd665a49b","usage":{"transactions/authorize":1,"transactions":1},"time":"2023-01-11 13:28:00 UTC"}
{"provider_key":"0849d4c669c041764addb65cd665a49b","usage":{"transactions/authorize":1,"transactions":1},"time":"2023-01-11 13:29:00 UTC"}
{"provider_key":"0849d4c669c041764addb65cd665a49b","usage":{"transactions/authorize":1,"transactions":1},"time":"2023-01-11 13:29:00 UTC"}
{"provider_key":"2baf37826393a700c01978dfaeeaa758","usage":{"transactions":1},"time":"2023-01-11 13:31:00 UTC"}
{"provider_key":"2baf37826393a700c01978dfaeeaa758","usage":{"transactions":1},"time":"2023-01-11 13:32:00 UTC"}
{"provider_key":"2baf37826393a700c01978dfaeeaa758","usage":{"transactions":1},"time":"2023-01-11 13:32:00 UTC"}
```
